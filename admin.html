<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>경희언어심리지원센터 - 관리자</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --mint-color: #98D8C6;
            --mint-dark: #7BC4B0;
            --mint-light: #B4E3D7;
            --text-dark: #2C3E50;
            --text-light: #666666;
            --background-light: #F8F9FA;
            --white: #FFFFFF;
            --shadow-sm: 0 2px 4px rgba(0,0,0,0.1);
            --shadow-md: 0 4px 6px rgba(0,0,0,0.1);
            --border-radius: 10px;
        }

        body {
            font-family: 'Noto Sans KR', sans-serif;
            background-color: var(--background-light);
        }

        .navbar {
            background-color: var(--white);
            box-shadow: var(--shadow-sm);
        }

        .navbar-brand {
            color: var(--mint-dark);
            font-weight: 700;
        }

        .card {
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-md);
            margin-bottom: 1rem;
        }

        .btn-mint {
            background-color: var(--mint-color);
            color: var(--white);
            border: none;
        }

        .btn-mint:hover {
            background-color: var(--mint-dark);
            color: var(--white);
        }

        .status-badge {
            padding: 0.5em 1em;
            border-radius: 20px;
            font-size: 0.85rem;
        }

        .status-pending {
            background-color: #ffd700;
            color: #000;
        }

        .status-confirmed {
            background-color: #28a745;
            color: #fff;
        }

        .status-cancelled {
            background-color: #dc3545;
            color: #fff;
        }

        .appointment-filters {
            background-color: var(--white);
            padding: 1rem;
            border-radius: var(--border-radius);
            margin-bottom: 1rem;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-light">
        <div class="container">
            <a class="navbar-brand" href="#">경희언어심리지원센터 관리자</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="#" id="logoutBtn">로그아웃</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <div class="appointment-filters">
            <div class="row">
                <div class="col-md-3">
                    <select class="form-select" id="statusFilter">
                        <option value="">모든 상태</option>
                        <option value="pending">대기중</option>
                        <option value="confirmed">확정</option>
                        <option value="cancelled">취소</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <select class="form-select" id="counselingTypeFilter">
                        <option value="">모든 상담 유형</option>
                        <option value="language">언어치료</option>
                        <option value="psychology">심리상담</option>
                        <option value="art">미술치료</option>
                        <option value="sand">모래치료</option>
                        <option value="group">그룹프로그램</option>
                    </select>
                </div>
                <div class="col-md-4">
                    <input type="date" class="form-control" id="dateFilter">
                </div>
                <div class="col-md-2">
                    <button class="btn btn-mint w-100" onclick="applyFilters()">필터 적용</button>
                </div>
            </div>
        </div>

        <div id="appointmentsList">
            <!-- 예약 목록이 여기에 동적으로 로드됩니다 -->
        </div>
    </div>

    <!-- 예약 상세 모달 -->
    <div class="modal fade" id="appointmentModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">예약 상세 정보</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="appointmentDetails"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
                    <button type="button" class="btn btn-mint" id="confirmAppointment">예약 확정</button>
                    <button type="button" class="btn btn-danger" id="cancelAppointment">예약 취소</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let currentAppointments = [];
        let selectedAppointmentId = null;

        // 페이지 로드 시 예약 목록 가져오기
        async function loadAppointments() {
            try {
                const response = await fetch('http://54.160.202.243:3000/api/appointments');
                const data = await response.json();
                currentAppointments = data;
                displayAppointments(data);
            } catch (error) {
                console.error('Error:', error);
                alert('예약 목록을 불러오는데 실패했습니다.');
            }
        }

        // 예약 목록 표시
        function displayAppointments(appointments) {
            const container = document.getElementById('appointmentsList');
            container.innerHTML = '';

            appointments.forEach(appointment => {
                const card = document.createElement('div');
                card.className = 'card mb-3';
                card.innerHTML = `
                    <div class="card-body">
                        <div class="row align-items-center">
                            <div class="col-md-3">
                                <h5 class="card-title mb-0">${appointment.name}</h5>
                                <small class="text-muted">${appointment.phone}</small>
                            </div>
                            <div class="col-md-3">
                                <p class="mb-0">${appointment.date} ${appointment.time || ''}</p>
                                <small class="text-muted">${appointment.counselingType}</small>
                            </div>
                            <div class="col-md-4">
                                <p class="mb-0">${appointment.message.substring(0, 50)}...</p>
                            </div>
                            <div class="col-md-2 text-end">
                                <span class="status-badge status-${appointment.status}">${getStatusText(appointment.status)}</span>
                                <button class="btn btn-sm btn-mint mt-2" onclick="showAppointmentDetails('${appointment._id}')">상세보기</button>
                            </div>
                        </div>
                    </div>
                `;
                container.appendChild(card);
            });
        }

        // 상태 텍스트 변환
        function getStatusText(status) {
            const statusMap = {
                'pending': '대기중',
                'confirmed': '확정',
                'cancelled': '취소'
            };
            return statusMap[status] || status;
        }

        // 예약 상세 정보 표시
        function showAppointmentDetails(appointmentId) {
            const appointment = currentAppointments.find(a => a._id === appointmentId);
            selectedAppointmentId = appointmentId;

            const detailsContainer = document.getElementById('appointmentDetails');
            detailsContainer.innerHTML = `
                <p><strong>이름:</strong> ${appointment.name}</p>
                <p><strong>연락처:</strong> ${appointment.phone}</p>
                <p><strong>이메일:</strong> ${appointment.email}</p>
                <p><strong>예약일시:</strong> ${appointment.date} ${appointment.time || ''}</p>
                <p><strong>상담유형:</strong> ${appointment.counselingType}</p>
                <p><strong>상담내용:</strong> ${appointment.message}</p>
                <p><strong>현재상태:</strong> <span class="status-badge status-${appointment.status}">${getStatusText(appointment.status)}</span></p>
            `;

            const modal = new bootstrap.Modal(document.getElementById('appointmentModal'));
            modal.show();
        }

        // 예약 상태 업데이트
        async function updateAppointmentStatus(status) {
            if (!selectedAppointmentId) return;

            try {
                const response = await fetch(`http://54.160.202.243:3000/api/appointments/${selectedAppointmentId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ status })
                });

                const result = await response.json();
                if (result.success) {
                    alert('예약 상태가 업데이트되었습니다.');
                    loadAppointments();
                    bootstrap.Modal.getInstance(document.getElementById('appointmentModal')).hide();
                } else {
                    alert('상태 업데이트에 실패했습니다: ' + result.error);
                }
            } catch (error) {
                console.error('Error:', error);
                alert('상태 업데이트 중 오류가 발생했습니다.');
            }
        }

        // 필터 적용
        function applyFilters() {
            const status = document.getElementById('statusFilter').value;
            const type = document.getElementById('counselingTypeFilter').value;
            const date = document.getElementById('dateFilter').value;

            let filtered = [...currentAppointments];

            if (status) {
                filtered = filtered.filter(a => a.status === status);
            }
            if (type) {
                filtered = filtered.filter(a => a.counselingType === type);
            }
            if (date) {
                filtered = filtered.filter(a => a.date === date);
            }

            displayAppointments(filtered);
        }

        // 이벤트 리스너 설정
        document.getElementById('confirmAppointment').addEventListener('click', () => updateAppointmentStatus('confirmed'));
        document.getElementById('cancelAppointment').addEventListener('click', () => updateAppointmentStatus('cancelled'));
        document.getElementById('logoutBtn').addEventListener('click', () => {
            // 로그아웃 로직 구현
            window.location.href = 'login.html';
        });

        // 초기 로드
        loadAppointments();
    </script>
</body>
</html> 